service:
  name: StackJanitor

# Add the serverless-webpack plugin
plugins:
  - serverless-webpack
  - serverless-step-functions
  - serverless-pseudo-parameters

provider:
  name: aws
  runtime: nodejs10.x
  region: ap-southeast-2

functions:
  logCloudFormationStack:
    handler: src/logCloudFormationStack.index

  deleteCloudFormationStack:
    handler: src/deleteCloudFormationStack.index

stepFunctions:
  stateMachines:
    StackJanitor:
      name: StackJanitorStateMachine
      definition:
        Comment: "StackJanitor State Machine"
        StartAt: logCloudFormationStack
        States:
          logCloudFormationStack:
            Type: Task
            Next: ShouldItBeMonitored
            Resource: arn:aws:lambda:#{AWS::Region}:#{AWS::AccountId}:function:${self:service}-${opt:stage}-logCloudFormationStack

          ShouldItBeMonitored:
            Type: Pass
            End: true

      events:
        - cloudwatchEvent:
            event:
              source:
                - "aws.cloudformation"
              detail:
                eventSource:
                  - "cloudformation.amazonaws.com"
                eventName:
                  - "CreateStack"
                  - "UpdateStack"
                  - "DeleteStack"
